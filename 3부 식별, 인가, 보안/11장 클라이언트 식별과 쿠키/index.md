## 11장 클라이언트 식별과 쿠키

### 1. 개별 접촉

- 현대 웹 사이트들은 개인화된 서비스를 제공하기 위해 사용자들이 브라우징하는 것을 기록하고 싶어한다.
  - 개별 인사
  - 사용자 맞춤 추천
  - 저장된 사용자 정보
  - 세션 추적

### 2. HTTP 헤더

![사용자에 대한 정보를 전달하는 HTTP 헤더](https://user-images.githubusercontent.com/74203440/207076832-1694d8ab-96a5-4912-83d2-c5c8932d6116.png)

- From 헤더
  - 사용자의 이메일 주소를 포함한다. 악의적인 서버가 이메일을 수집하여 스팸 메일 발송하는 문제가 있기 때문에 From 헤더를 보내는 브라우저는 많지 않다.
  - 로봇이나 스파이더가 데이터를 수집하는 과정에서 웹 사이트에 문제를 일으켰을 경우 웹 마스터가 항의 메일을 보낼 수 있도록 From 헤더에 이메일 주소를 기술한다.
- User-Agent 헤더
  - 사용자가 쓰고 있는 브라우저의 이름과 버전 정보, 운영체제 정보까지 포함하여 서버에게 알려준다.
  - 특정 사용자를 식별하는데는 큰 도움이 되지 않는다.
- Referer 헤더
  - 사용자가 현재 페이지로 유입하게 한 웹페이지의 URL을 가리킨다.
  - 사용자를 식별할 수는 없지만 이전에 방문한 페이지를 알려준다.
  - 웹 사용 행태나 사용자의 취향을 더 잘 파악할 수 있다.

### 3. 클라이언트 IP 주소

- 초기에는 클라이언트의 IP주소를 사용하려 했는데, 주소가 잘 바뀌지 않고 웹 서버가 요청마다 클라이언트의 IP를 알 수 있다면 문제없이 동작한다.
- 클라이언트 IP 주소로 사용자를 식별하는 방식은 여러 약점이 있다.
  - 클라이언트 IP 주소는 사용 컴퓨터를 가리키기 때문에 여러 사용자가 같은 컴퓨터를 사용하면 식별이 어렵다.
  - 동적 IP 주소 할당으로 매번 다른 주소를 받기 때문에 웹 서버는 사용자를 IP 주소로 식별할 수 없다.
  - 부족한 주소 관리 때문에 네트워크 주소 변환(Network Address Translation, NAT) 방화벽을 통해 인터넷을 사용한다. 실제 IP 주소를 방화벽 뒤로 숨기고 다른 방화벽 IP 주소로 변환한다.
  - 웹 서버는 클라이언트의 IP 주소 대신 프락시 서버의 IP 주소를 본다. 일부 프락시는 원본 IP 주소를 보존하려 하지만 모든 프락시가 그렇지 않다.
- 인트라넷 같은 제한된 영역에서 특정 IP 주소로부터 오는 사용자에게만 문서를 전달하기도 한다.

### 4. 사용자 로그인

- HTTP는 WWW-Authenticate 와 Authorization 헤더를 사용해 웹 사이트에 사용자 이름을 전달하는 자체적인 체계를 가지고 있고, 브라우저는 사이트로 보내는 모든 요청에 로그인 정보를 함께 보내므로 웹 서버는 로그인 정보를 확인할 수 있다.

### 5. 뚱뚱한 URL

- 사용자의 상태 정보를 포함하는 URL을 뚱뚱한 URL이라고 한다.
  - ex) 식별번호 : 002-1145265-8016838
  - "/exec/obidos/tg/browse/-/229220/ref=gr_gifts/002-1145265-8016838"
- 웹 서버와 통신하는 독립적인 HTTP 트랜잭션을 하나의 '세션' 혹은 '방문'으로 묶는 용도로 뚱뚱한 URL을 사용할 수 있다.
- 사용자가 웹 사이트에 처음 방문하면 유일한 ID가 생성되고, 서버가 인식할 수 있는 방식으로 URL에 추가되며, 서버는 클라이언트를 뚱뚱한 URL로 리다이렉트 시킨다. 서버가 뚱뚱한 URL을 포함한 요청을 받으면 사용자 아이디와 관련된 추가 정보를 찾아서 밖으로 향하는 모든 하이퍼링크를 뚱뚱한 URL로 바꾼다.
- 뚱뚱한 URL에도 문제가 있다.
  - URL이 사용자들에게 혼란을 준다.
  - 공유시에 개인 정보 유출의 위험이 있다.
  - URL이 달라지기 때문에 기존 캐시에 접근 할 수 없다.
  - HTML 페이지를 다시 그려야 해서 서버 부하를 가중시킨다.
  - 다른 사이트로 이동하면 뚱뚱한 URL세션에서 이탈하기 쉽다. 장바구니 같은 것들이 초기화 된다.
  - 로그아웃 시 모든 정보를 잃게 된다.
  

### 11.6 쿠키

- 쿠키는 사용자를 식별하고 세션을 유지하는 방식 중 현재까지 가장 널리 사용하는 방식.
- 쿠키와 캐시가 충돌할 수 있어서 쿠키의 내용물은 캐싱하지 않음

#### 11.6.1 쿠키의 타입
쿠키는 **세션 쿠키(session cookie)와 지속 쿠키(persistent cookie)** 두 가지 타입으로 나눌 수 있다.

| |세션 쿠키|지속쿠키|
|:-:|:-:|:-:|
|내용|사용자 설정과 선호를 저장하는 임시 쿠키|주기적으로 방문하는 사이트에 대한 설정 정보나 로그인 유지|
|저장 방식|브라우저를 닫으면 삭제됨|디스크에 저장되어 브라우저나 컴퓨터를 재시작 해도 유지됨|
|파라미터|discard 파라미터를 포함|Expires, Max-age파라미터를 포함|

#### 11.6.2 쿠키는 어떻게 동작하는가
1. 사용자가 웹 서버를 방문한다. 서버는 사용자에 대해 아무 것도 모른다.
2. 서버는 사용자를 식별하기 위한 값을 쿠키에 할당한다.
	- 쿠키는 `이름 = 값` 형태의 리스트이다.
	- 서버는 이 리스트를 `Set-Cookie` 혹은 `Set-Cookie2(확장 헤더)` 헤더에 담아 클라이언트에 전달한다.
3. 브라우저는 서버에서 온 `Set-Cookie` 헤더에 있는 쿠키를 데이터베이스에 저장한다.
4. 사용자가 나중에 같은 사이트를 방문하면 브라우저는 `Cookie` 헤더에 쿠키를 담아 전송한다.

#### 11.6.3 쿠키 상자: 클라이언트 측 상태
- 브라우저는 쿠키 정보를 저장할 책임이 있다. 이 시스템을 '클라이언트 측 상태'라고 명시하며 쿠키 명세에서 공식 이름으로 'HTTP 상태 관리 체계(HTTP state Management Mechanism)'이라고 부른다.

**구글 크롬 쿠키**
- 크롬은 Cookies라는 SQLite 파일에 쿠키를 저장한다. 

- **Name**. 쿠키의 이름.
- **Value**. 쿠키의 값.
- **Domain**. 쿠키 수신이 허영된 호스트.
- **Path**. 쿠키 헤더를 요청하기 위해 요청된 URL
- **Expires / Max-Age**. 쿠키의 만료 날짜. [세션 쿠키](https://developer.mozilla.org/docs/Web/HTTP/Cookies#define_the_lifetime_of_a_cookie) 의 경우 이 값은 'alway'
- **Size**. 쿠키의 사이즈(바이트).
- **HTTP**.  true인 경우 쿠키가 HTTP를 통해서만 사용되어야 하며 JavaScript 수정이 허용되지 않음.
- **Secure**. true인 경우 HTTPS 연결을 통해서만 서버로 전송될 수 있음.

#### 11.6.4 사이트마다 각기 다른 쿠키들
- 브라우저는 각 사이트에 모든 쿠키를 보내지 않는다.
- 보통 브라우저는 쿠키를 생성한 서버에게만 해당 쿠키를 전달한다.
- 쿠키를 모두 전달하면 성능이 저하된다. 콘텐츠보다 쿠키가 더 클 수도 있다.
- 쿠키의 대부분은 서버에 특화된 '이름/값' 쌍을 포함하고 있기 때문에 사이트에서는 무의미한 값이다.
- 모든 사이트에 쿠키 전체를 전송하면 특정 사이트에서 만든 쿠키를 신뢰하지 않는 사이트로 보는 개인정보 문제가 생길 수 있다.

> **쿠키 Domain 속성**
> 서버는 쿠키를 생성할 때 `Set-Cookie` 응답 헤더에 `Domain` 속성을 기술해 어떤 사이트가 그 쿠키를 읽을 수 있는지 제어할 수 있다.
> 
> **쿠키 Path 속성**
> `Path`속성을 기술하면 웹사이트 일부에만 쿠키를 적용할 수 있다.

#### 11.6.5 쿠키 구성요소
Version 0 쿠키(넷스케이프 쿠키)와 Version 1 쿠키(RFC 2965)가 있다. 2011년 최신화 된 RFC 6265 'HTTP State Management Machanism'이 발표되었다.

#### 11.6.6 Version 0(넷스케이프 쿠키)
최초의 쿠키 명세. `Set-Cookie` 응답 헤더와 `Cookie` 요청 헤더와 쿠키를 조작하는데 필요한 필드들을 정의. 가장 오래되었지만 아직까지도 많은 곳에서 사용되고 있다. 

```http
Set-cookie: name=value [; expires=date] [; path=path] [; domain=domain] [; secure]

Cookie: name1=value1 [; name2=value]
```

|속성|설명|예시|
|:-:|:-:|:-:|
|이름=값|세미콜론, 쉼표, 등호, 공백은 포함할 수 없다 (단, 큰따옴표로 감싸면 가능)|Set-Cookie: customer=Mary|
|Expires|쿠키 만료 시각 (GMT 타임존만 사용 가능)|Set-Cookie: foo=bar; expires=Wednesday, 09-Dec-22 23:12:40 GMT|
|Domain |서버가 특정 도메인에만 쿠키를 제한적으로 전달하게 한다. 두 개에서 세 개 영역을 가지는 도메인을 기술해야 한다. (.com, .edu 같은 것만으로는 안됨)|Set-Coookie: SHIPPING=FEDEX; domain="google.com"|
|Path|서버에 있는 특정 문서에만 쿠키를 할당할 수 있다.|Set-Cookie: lastorder=00183; path=/orders|
|Secure|이 속성이 포함되어 있으면 SSL 보안 연결을 사용할 때만 쿠키를 전송한다.|Set-Cookie: private_id=519; secure|

#### 11.6.7 Version 1 (RFC 2965) 쿠키
넷스케이프 쿠키의 확장버전으로 `Set-Cookie2`와 `Cookie2` 헤더를 소개한다. 현재는 폐기되어 더 이상 지원되지 않는다.

**Version 0 쿠키와의 차이점**
- 쿠키마다 목적을 설명하는 설명문이 있다.
- 만료 주기와 상관없이 브라우저가 닫힐 때 쿠키를 삭제할 수 있다.
- 절대 날짜(Expires) 대신 초 단위의 상대 값(Max-age)으로 쿠키의 생명주기를 결정한다.
- 포트 번호로도 쿠키를 제어한다.
- 버전 번호가 추가되었다.
- Cookie 헤더에 $ 접두어가 있다.

~~발표 당시(2000년)에도 업계에선 반응이 싸늘했다고...~~

#### 11.6.8 쿠키와 세션 추적
<img width="389" alt="스크린샷 2022-12-11 오전 3 26 30" src="https://user-images.githubusercontent.com/87509645/206869930-2f5a4f56-54ad-4ded-bd55-0d8e387316d5.png">


#### 11.6.9 쿠키와 캐싱
쿠키와 관련된 문서를 캐싱하면 사용자의 쿠키가 다른 사용자에게 할당되거나, 개인 정보가 노출될 수 있다.

**캐시되지 말아야 할 문서가 있다면 표시하라**
- `Set-Cookie` 빼고 캐시를 해도 된다면, 명시적으로 `Cache-Control: no-cache="Set-Cookie"`를 표시한다.
- 캐시를 해도 되는 문서에는 `Cache-Control: public`을 사용한다.
 
**`Set-Cookie` 헤더를 캐시하는 것에 유의하라**
- (서버의 응답에) 어떤 캐시는 `Set-Cookie` 헤더를 제거한다.
	- 캐시가 모든 요청마다 원 서버에 재검사하도록 만들 수 있다.
	- 재검사를 위해 `Cache-Control: must-revalidate, max-age=0`을 추가한다.
- 더 보수적인 캐시는 `Set-Cookie`를 가지고 있는 응답은 아예 캐싱하지 않는다.

**`Cookie` 헤더를 갖고 있는 요청을 주의하라**
- (클라이언트의 요청에서) 보수적인 캐시는 `Cookie` 헤더가 있는 요청에 대한 응답은 캐시하지 않는다.
	- 이미지는 캐싱하고 텍스트는 캐싱하지 않을 수도 있다.
	- 이미지에 `Max-age`가 0인 `Cookie` 헤더를 설정해 매번 재검사하게 만들 수 있다.

#### 11.6.10 쿠키, 보안 그리고 개인정보

- 쿠키 자체가 보안상으로 엄청나게 위험한 것은 아니다. 
- 오히려 원격 DB에 개인 정보를 저장하고 해당 데이터의 키 값을 쿠키에 저장하는 방식을 표준으로 사용하면, 클라이언트와 서버 사이에 예민한 데이터가 오가는 것을 줄일 수 있다.

- 협력업체 웹사이트가 사용자를 추적하려고 지속 쿠키를 사용하는 오용은 주의해야 한다.(광고 웹사이트...)
- 제공하는 개인정보를 누가 받는지 명확히 알고 유의하면 쿠키에 관한 위험성보다 세션 조작이나 트랜잭션상의 편리함이 더 크다.

