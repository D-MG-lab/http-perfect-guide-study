## 7장 캐시

웹 캐시는 자주 쓰이는 문서의 사본을 자동으로 보관하는 HTTP 장치다. 웹 요청이 캐시에 도착했을 때, 캐시된 로컬 사본이 존재한다면, 그 문서는 원 서버가 아니라 그 캐시로부터 제공된다. 
- 불필요한 데이터 전송을 줄여, 네트워크 비용 감소.
- 네트워크 병목 감소, 대역폭을 늘리지 않고 빠른 페이지를 응답.
- 원 서버 요청을 줄여 서버 부하 감소, 더 빠른 응답.
- 페이지를 먼 곳에서 불러 올 때 생기는 거리로 인한 지연 감소.

#### 7.1 불필요한 데이터 전송
복수의 클라이언트가 자주 쓰이는 원 서버의 페이지에 접근시, 각 요청마다 같은 문서를 반복 전송하게 된다. 이런 불필요한 전송은 네트워크 대역폭을 잡아먹고, 전송을 느리게하며, 웹 서버에 부하를 준다. 캐시를 이용해 첫번째 응답을 캐시에 보관하고 뒤이은 요청에서는 캐시된 사본을 응답으로 사용하면 중복으로 트래픽을 주고 받는 낭비를 줄일 수 있다.

#### 7.2 대역폭 병목
특히 큰 문서를 응답받아야 하는 경우, 보통 네트워크는 (WAN보다) 로컬 클라이언트(LAN)에 더 넓은 대역폭을 제공하기 때문에 빠른 LAN에 있는 캐시로부터 cached사본을 가져온다면 성능을 대폭 개선할 수 있다. 
<br /><img width="366" alt="Screen Shot 2022-11-13 at 7 39 39 PM" src="https://user-images.githubusercontent.com/54028005/201517458-6e2a47dc-99b1-468c-83a9-0b50c26a563b.png">

#### 7.3 갑작스런 요청 쇄도(Flash Crowds)
트래픽 급증은 네트워크와 웹 서버에 심각한 장애 및 과부하를 야기시키며, 이때 캐싱이 특히 중요하다.

#### 7.4 거리로 인한 지연
대역폭이 문제가 되지 않더라도 거리가 문제가 될 수 있다. 모든 네트워크 라우터는 저마다 인터넷 트래픽을 지연시키며, 병렬(parallel)이면서 keep-alive 커넥션(persistent-connection)이라해도 광속 그 자체는 상당한 지연을 유발한다.

#### 7.5 적중과 부적중 (Hits and Misses)
- 캐시에 요청이 도착했을 때 그에 대응하는 사본이 있다면 그를 이용해 요청이 처리될 수 있으며 이를 cache hit라고 한다.
- 반면, 사본이 없다면 원 서버로 요청이 전달될 뿐인데, 이를 cache miss라고 부른다.
- 원 서버 콘텐츠는 변경될 수 있기 때문에, 캐시는 반드시 사본이 최신상태로 유지되는지 서버를 통해 주기적으로 점검해야한다. 이런 최신상태 체크를 재검사(Revalidation)이라고 한다.
- 캐시는 스스로 원한다면 언제든 사본을 재검사 할 수 있다. 그러나 캐싱된 문서가 수백만 개되는데에 비해 네트워크 대역폭은 부족하기 때문에, 클라이언트가 사본을 요청했으며 그 사본이 검사할 필요가 있을 정도로 충분히 오래된 경우에만 재검사를 한다.
  - 재검사 적중 / 느린 적중 : 캐시는 사본의 재검사가 필요할 때, 원 서버에 재검사 요청을 보낸다. -> 콘텐츠가 변경되지 않았다면 304 not modified 응답을 보낸다. -> 그 사본이 여전히 유효함을 알게 된 캐시는 즉각 임시로 사본이 최신이라고 표시한뒤 클라이언트에 제공한다.
- 속도 비교 : 순수 캐시 적중(캐시사본을 바로 클라이언트에 전송) < 재검사 적중 / 느린 적중 (원서버와 검사를 해야함) < 캐시 부적중 (원서버로부터 문서객체 전체를 받아와야함. 200 ok, 삭제됐다면 404 not found)
- If-Modified-Since 헤더 : 서버에 보내는 GET 요청 헤더에 추가해 보내면 캐시된 이후에 변경된 경우에만 사본을 보내달라는 의미.
- 캐시 (문서)적중률 : 캐시가 얼마나 큰지, 캐시 사용자들의 관심사가 얼마나 비슷한지, 캐시된 데이터가 얼마나 얼마나 자주 변경되거나 개인화되는지, 캐시가 어떻게 설정되어있는지에 따라 달라진다. 적중률을 예측하기 어렵기로 악명높지만, 캐시는 유용한 콘텐츠가 캐시에 머무르도록 보장하기 위해 노력하며 성능 개선에 상당한 도움이 된다.
- 바이트 적중률 : 문서들은 다 다른 크기이며 큰 객체를 덜 접근되지만 전체 트래픽에는 더 크게 기여하기 때문에, 바이트 단위 적중률 측정값을 더 유의미하게 보기도 한다. 
  - 문서 적중률은 얼마나 많은 웹 트랜잭션을 외부로 보내지 않았는지에 대한 지표로 이를 개선하면 전체 지연 대기 시간을 줄여주며,   - 바이트 적중률은 얼마나 많은 바이트가 인터넷으로 나가지 않았는지에 대한 지표로서 대역폭 절약을 최적화해준다.
- 적중과 부적중의 구별 : HTTP는 클라이언트에게 캐시 적중 여부를 알려주지 않는다. 두 경우 모두 200OK. 클라이언트가 알아낼 수 있느 방법으로 
  - via헤더에서 캐시에 무슨일이 일어났는지에 대한 부가 정보, 
  - Date헤더의 응답 생성일 정보, 
  - Age헤더의 응답이 얼마나 오래되었는지에 대한 정보를 이용할 수 있다.
