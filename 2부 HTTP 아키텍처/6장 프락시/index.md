## 6장 프락시

### 6.6 메시지 추적
오늘날 웹 요청의 상당수가 프록시를 지나간다. 
- 보안,성능을 위한 프록시 캐시
- 성능 개선, 기능 구현을 위한 ISP의 프록시 캐시
프록시가 점점 더 흔해지면서, 서로 다른 스위치나 라우터를 넘나드는 IP 패킷의 흐름을 추적하는 것 못지 않게 프락시를 넘나드는 메시지의 흐름을 추적하고 문제점을 찾아내는 것도 필요한 일이 되었다.
- #### Via 헤더
    - 메시지가 지나는 각 중간 노드(프록시나 게이트웨이)의 정보를 (필수적으로) 나열한다.
    - ex. Via: 1.1 proxy-62.irenes-net, 1.0 cache.joes-hardware.com
    - 메세지의 전달을 추적하고, 메세지 루프를 진단하고, 요청-응답의 과정에 관여하는 모든 메세지 발송자들의 프로토콜을 다루는 능력을 알아보기 위해 사용된다.
    - 프록시는 자신의 유니크한 문자열을 via헤더에 삽입하여 요청에 이 문자열이 포함되었는지 검사하는 방식으로, 네트워크 라우팅 루프를 탐지하는 데에 사용되기도 한다. 
    - via 헤더 문법
        - 각 waypoint 마다 프로토콜 이름, 프로토콜 버전, 노드 이름, 노드 코멘트 총 4개의 구성 요소를 담는다.
        - 프로토콜 이름 : 프록시가 받은 프로토콜 명시, HTTP라면 생략 가능.
        - 프로토콜 버전 : 애플리케이션이 자신 이전의 모든 프록시가 어떤 버전을 다룰 수 있는지 확인.
        - 노드 이름 : 프록시의 호스트와 포트 번호. 호스트는 가명으로도 사용 가능.
        - 노드 코멘트 : 벤더나 버전 정보를 포함하며, 장치에서 일어난 이벤트진단 정보를 포함. 선택적인 구성요소.
     - 요청과 응답 경로 : 보통 같은 TCP 커넥션을 오가므로, 응답은 요청과 같은 경로로 되돌아 간다. ( A -> B -> C <=> C -> B -> A)
     - 게이트웨이 : 비HTTP 프로토콜을 사용할 수 있는 게이트웨이 기능 제공
     - 서버 헤더 : 서버헤더는 원 서버에 의해 사용되는 소프트웨어를 알려주며 수정되지 말아야한다. 대신 프록시는 via 항목을 추가한다.
     - via가 개인정보 보호와 보안에 미치는 영향
        - 프록시 서버가 네트워크 방화벽의 일부인 경우 방화벽 뒤의 호스트이름과 포트를 전달해서는 안된다. 이때 보안 경계선인 프록시는 호스트명을 가명으로 교체한다. 단, via 경유시 항목을 유지하려 노력하여야 하며, 이 유지 항목들은 같은 조직하에 가명으로 교체된 호스트이며 수신된 프로토콜이 같다면 하나로 합칠 수 있다. (ex. concealed-stuff)
- #### TRACE 메서드
프록시 서버는 메세지가 전달될때마다 메세지를 바꿀 수 있기 때문에 프록시가 복잡해질 수록 상호운용성 문제가 증가한다. 프록시 네트워크를 진단하기 위해 홉 바이 홉 메세지 내용을 관찰할 방법이 필요하다.
TRACE 메소드는 이런 요청 메세지를 프록시 연쇄를 따라가면서 어떤 프록시를 지나고 어떻게 메세지가 수정되는지 관찰/추적해 디버깅할 수 있도록 해준다. 최종 목적지 서버에 도착하면, 전체 요청 메세지와 프록시 목록 (via 헤더 안의 목록)을 검사할 수 있다. *Contennt-Type : message/http 200 ok
- Max-Forwards : 프록시 홉의 갯수를 제한해 메세지가 무한루프에 빠지지 않는지 체크하거나 프록시 연쇄의 중간에 특정 프록시의 효과를 체크할 때 사용한다. 또한, OPTIONS 메세지의 전달 횟수도 제한할 수 있다. 0인 경우 원 서버가 아니더라도 TRACE메세지를 더이상 전달하지 않고 클라이언트에 돌려줘야 한다.

### 6.7 프록시 인증
제한된 콘텐츠 요청이 프록시에 도착하면 407 Proxy Authorization Required 상태코드와 Proxy-Authenticate 헤더 필드를 함께 반환한다. 이 auth를 수집해 헤더에 담아 다시 요청하면 원 요청을 통과 시키고 그렇지 않으면 407를 반환한다. 프록시 연쇄상에 인증을 요구하는 여러 프록시가 있을 경우 일반적으로 잘 동작하지 않는데, 프록시 연쇄의 특정 경유지와 인증 자격을 확장하는 HTTP 기능은 널리 구현되지는 않았다. (HTTP 인증 메커니즘은 12장 참고)
### 6.8 프록시 상호운용성
프록시 서버는 서로 다른 프로토콜을 구현했을 수도 있는 클라이언트와 서버 사이를 중개해야한다. 
프록시는 이해할 수 없는 헤더 필드를 만나면 반드시 그대로 전달해야하며, 같은 이름의 헤더 필드가 여러개 있느 경우 순서도 반드시 유지해야한다.
- OPTIONS 메소드는 특정 리소스가 어떤 기능/메소드를 지원하는지 클라이언트(혹은 프록시)가 알아볼 수 있게 해준다. * 로 요청 URI를 사용하면 서버 전체의 능력에 대해 묻는 것이 된다. 
- Allow 헤더는 요청 리소스에 대해 서버가 지원하는 모든 메서드를 열거한다. (ex. Allow : GET, HEAD, PUT). 만약 프록시가 모든 메소드를 이해할 수 없더라도 프록시는 Allow 헤더 필드를 수정할 수 없다. 왜냐하면 클라이언트는 원 서버와 대화할 다른 경로를 가지고 있을 수도 있기 때문이다. 
