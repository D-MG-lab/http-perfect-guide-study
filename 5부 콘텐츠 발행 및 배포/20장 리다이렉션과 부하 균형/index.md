### 20.5 프락시 리다이렉션 방법

- 일반적인 리다이렉션은 프락시를 통하거나 네트워크에 있는 프락시 캐시를 이용한다.
- 웹브라우저와 같은 클라이언트가 프락시로 가는 길을 아는 방법 3가지
  - 명시적인 브라우저 설정
  - 동적인 자동 설정
  - 자연스러운 가로채기
- 프락시는 클라이언트의 요청을 다른 프락시로 리다이렉트 할 수 있다.

#### 20.5.1 명시적 브라우저 설정

- 브라우저에는 프락시 서버에 접촉하기 위해 프락시 이름, 아이피 주소, 포트번호를 설정할 수 있는 풀다운 메뉴가 존재한다.
- 미리 설정되어있는 브라우저들은 프락시와 접촉하는 주소를 알고 있다.
- 명시적인 브라우저 설정의 단점
  - 프락시를 사용하도록 설정된 브라우저들은 프락시가 잘못되었을 경우 원 서버와 접촉하지 않아 이용자는 접속 문제를 경험한다.
  - 네트워크 아키텍처를 변경했을 때 모든 사용자들에게 변경사항을 전파하는 것이 어렵다.

#### 20.5.2 프락시 자동 설정

- 올바른 프락시 서버에 접촉하기 위해 브라우저가 동적으로 자신을 설정할 수 있게 하는 자동 설정 방법은 네트워크 아키텍처 변화로 인한 문제를 해결한다.
- 프락시 자동설정(PAC, Proxy Auto-configuration) 프로토콜
  - 넷스케이프 사에 의해 정의되었고, 거의 모든 브라우저가 지원한다.
  - 브라우저들이 URL별로 접촉해야 할 프락시를 지정한 PAC 파일이라 부르는 특별한 파일을 찾도록 한다. 브라우저는 PAC 파일을 얻기 위해 지정된 서버에 접촉하도록 설정되어야 하고, 재시작할 때마다 PAC 파일을 가져온다.
  - PAC 파일은 `function FindProxyForURL(url, host)` 함수를 반드시 정의해야하는 자바스크립트 파일이다.
  - 브라우저는 요청된 URL마다 `return_value = FindProxyForURL(url_of_request, host_in_url)` 함수를 호출
  - 프락시의 위치가 변경된 경우 이를 반영하기 위해 PAC 파일이 서버에서 업데이트되기 대문에 PAC는 브라우저가 자동으로 네트워크 아키텍처 안에서의 변경에 맞는 올바른 프락시에 접촉할 수 있도록 해줄 수 있다.ㅎ
    ![프락시 자동 설정](https://user-images.githubusercontent.com/74203440/211302308-d7a20f98-1311-4711-9ac8-370d7fb4c9aa.jpeg)

#### 20.5.3 웹 프락시 자동발견 프로토콜(Web Proxy Autodiscovery Protocol)

**PAC 파일 자동발견**

- WPAD는 HTTP클라이언트가 PAC파일 위치를 알아내고 PAC파일을 이용하여 적절한 프락시 서버의 이름을 알아낼 수 있게 한다.
- WPAD 프로토콜은 설정 URL(CURL)이라고 알려진 PAC파일 URL 발견하고, 적절한 프락시 서버의 주소를 반환하는 자바스크립트 프로그램을 실행한다.

**WPAD 알고리즘**

- WPAD는 적절한 PAC 파일 CURL을 결정하기 위해 여러 리소스 발견 기법들을 사용한다.
- WPAD 클라이언트에게는 오직 DHCP와 DNS에게 알려진 호스트 명 기법만 요구된다.
- WPAD 클라이언트는 앞에서 언급한 발견 메커니즘을 이용해서 리소스 발견 요청을 순서대로 보낸다. 발견 시도가 성공할 때마다, 클라이언트는 PAC CURL을 생성하기 위해 취득한 정보를 사용한다.
- PAC파일이 CURL에서 성공적으로 발견되면 과정은 완료된다.
- 모든 메커니즘을 시도한 후에도 PAC파일을 찾지 못하면 WPAD 프로토콜은 실패하고 클라이언트는 프락시 서버를 사용하지 않는 것으로 설정된다.

**DHCP를 이용한 CURL 발견**

- WPAD 클라이언트가 질의하는 DHCP 서버는 반드시 CURL을 저장하고 있어야 한다.
- WPAD 클라이언트는 DHCP 질의를 DHCP 서버에 보냄으로써 CURL을 얻는다.
- WPAD 클라이언트가 자신의 초기화 과정에서 이미 DHCP 질의를 했다면 DHCP 서버는 이미 그 값을 제공했을 수도 있다.
- WPAD를 위한 DHCP 옵션 코드 252는 임의의 길이의 문자열이고, 적절한 PAC파일을 가리키는 URL을 포함한다.
  ex) `http://server.domain/proxyconfig.pac`

**DNS A 레코드 룩업**

- 이 메커니즘이 동작하려면, 알맞는 프락시 서버의 IP주소들이 WPAD 클라이언트들이 질의할 수 있는 DNS 서버에 반드시 저장되어 있어야 한다.
- WPAD 클라이언트는 A레코드 룩업을 DNS 서버로 보내 CURL을 얻는다.
- 룩업이 성공하면 적절한 프락시 서버의 IP주소를 얻는다.

**PAC 파일 가져오기**

- 한번 후보 CURL이 생성되면, WPAD 클라이언트는 보통 그 CURL로 GET요청을 만드는데, 이때 자신이 다룰 수 있는 적절한 CFILE 포맷 정보가 담긴 Accept 헤더를 포함해야 한다.
  ex) `Accept: application/x-ns-proxy-autoconfig`
- CURL 결과가 리다이렉트라면, 그곳이 클라이언트의 최종 목적지이다.

**언제 WPAD를 실행하는가**

- 웹 클라이언트가 시작될 때와 클라이언트 호스트의 아이피 주소가 변경된 네트워킹 스택으로부터 어떤 언급이 있을 때마다 WPAD가 실행된다.
- PAC 파일이 만료되면 클라이언트는 WPAD프로세스를 재시작해야한다.
- PAC 파일이 대체품을 제공하지 않고 현재 설정된 프락시가 동작하지 않으면 WPAD 프로세스를 재실행하도록 구현할 수 있다.
- 클라이언트가 현재 PAC 파일을 무효화 하기로 했다면, 최신의 올바른 CURL을 가져오는 것을 보장하기 위해 반드시 전체 WPAD 프로토콜을 재실행해야 한다.

**WPAD 스푸핑(spoofing)**

- WPAD의 IE5구현은 사용자의 개입 없이 웹 클라이언트가 프락시 설정을 자동으로 탐지하는 것을 가능하게 했다. WPAD 알고리즘은 호스트 명 'wpad'를 도메인 이름의 절대 표기 앞에 붙이고 WPAD 서버를 찾아내거나 3차 도메인에 도달할 때까지 계속해서 서브도메인을 지운다.

**타임아웃**

- 여러 발견 단계를 거치게 되며, 클라이언트는 각 단계가 일정한 시간 내에 끝나는지 반드시 확인해야 한다.
